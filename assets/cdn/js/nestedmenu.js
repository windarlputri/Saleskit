(function(a){var b=window.define;if(typeof b==="function"&&b.amd){b(["jquery","jquery-ui/sortable"],a)}else{a(window.jQuery)}}(function(b){function a(d,c,e){return(d>c)&&(d<(c+e))}b.widget("mjs.nestedSortable",b.extend({},b.ui.sortable.prototype,{options:{disableParentChange:false,doNotClear:false,expandOnHover:700,isAllowed:function(){return true},isTree:false,listType:"ol",maxLevels:0,protectRoot:false,rootID:null,rtl:false,startCollapsed:false,tabSize:20,branchClass:"mjs-nestedSortable-branch",collapsedClass:"mjs-nestedSortable-collapsed",disableNestingClass:"mjs-nestedSortable-no-nesting",errorClass:"mjs-nestedSortable-error",expandedClass:"mjs-nestedSortable-expanded",hoveringClass:"mjs-nestedSortable-hovering",leafClass:"mjs-nestedSortable-leaf",disabledClass:"mjs-nestedSortable-disabled"},_create:function(){var c=this,d;this.element.data("ui-sortable",this.element.data("mjs-nestedSortable"));if(!this.element.is(this.options.listType)){d="nestedSortable: Please check that the listType option is set to your actual list type";throw new Error(d)}if(this.options.isTree&&this.options.expandOnHover){this.options.tolerance="intersect"}b.ui.sortable.prototype._create.apply(this,arguments);if(this.options.isTree){b(this.items).each(function(){var g=this.item,e=g.hasClass(c.options.collapsedClass),f=g.hasClass(c.options.expandedClass);if(g.children(c.options.listType).length){g.addClass(c.options.branchClass);if(!e&&!f){if(c.options.startCollapsed){g.addClass(c.options.collapsedClass)}else{g.addClass(c.options.expandedClass)}}}else{g.addClass(c.options.leafClass)}})}},_destroy:function(){this.element.removeData("mjs-nestedSortable").removeData("ui-sortable");return b.ui.sortable.prototype._destroy.apply(this,arguments)},_mouseDrag:function(q){var r,t,v,h,l=this,m=this.options,d=false,x=b(document),j,k,c,u,p,n,f,e,w,s,g,y;this.position=this._generatePosition(q);this.positionAbs=this._convertPositionTo("absolute");if(!this.lastPositionAbs){this.lastPositionAbs=this.positionAbs}if(this.options.scroll){if(this.scrollParent[0]!==document&&this.scrollParent[0].tagName!=="HTML"){if((this.overflowOffset.top+this.scrollParent[0].offsetHeight)-q.pageY<m.scrollSensitivity){d=this.scrollParent.scrollTop()+m.scrollSpeed;this.scrollParent.scrollTop(d)}else{if(q.pageY-this.overflowOffset.top<m.scrollSensitivity){d=this.scrollParent.scrollTop()-m.scrollSpeed;this.scrollParent.scrollTop(d)}}if((this.overflowOffset.left+this.scrollParent[0].offsetWidth)-q.pageX<m.scrollSensitivity){d=this.scrollParent.scrollLeft()+m.scrollSpeed;this.scrollParent.scrollLeft(d)}else{if(q.pageX-this.overflowOffset.left<m.scrollSensitivity){d=this.scrollParent.scrollLeft()-m.scrollSpeed;this.scrollParent.scrollLeft(d)}}}else{if(q.pageY-x.scrollTop()<m.scrollSensitivity){d=x.scrollTop()-m.scrollSpeed;x.scrollTop(d)}else{if(b(window).height()-(q.pageY-x.scrollTop())<m.scrollSensitivity){d=x.scrollTop()+m.scrollSpeed;x.scrollTop(d)}}if(q.pageX-x.scrollLeft()<m.scrollSensitivity){d=x.scrollLeft()-m.scrollSpeed;x.scrollLeft(d)}else{if(b(window).width()-(q.pageX-x.scrollLeft())<m.scrollSensitivity){d=x.scrollLeft()+m.scrollSpeed;x.scrollLeft(d)}}}if(d!==false&&b.ui.ddmanager&&!m.dropBehaviour){b.ui.ddmanager.prepareOffsets(this,q)}}this.positionAbs=this._convertPositionTo("absolute");j=this.placeholder.offset().top;if(!this.options.axis||this.options.axis!=="y"){this.helper[0].style.left=this.position.left+"px"}if(!this.options.axis||this.options.axis!=="x"){this.helper[0].style.top=(this.position.top)+"px"}this.hovering=this.hovering?this.hovering:null;this.mouseentered=this.mouseentered?this.mouseentered:false;(function(){var i=this.placeholder.parent().parent();if(i&&i.closest(".ui-sortable").length){k=i}}.call(this));c=this._getLevel(this.placeholder);u=this._getChildLevels(this.helper);f=document.createElement(m.listType);for(r=this.items.length-1;r>=0;r--){t=this.items[r];v=t.item[0];h=this._intersectsWithPointer(t);if(!h){continue}if(t.instance!==this.currentContainer){continue}if(v.className.indexOf(m.disabledClass)!==-1){if(h===2){p=this.items[r+1];if(p&&p.item.hasClass(m.disabledClass)){continue}}else{if(h===1){n=this.items[r-1];if(n&&n.item.hasClass(m.disabledClass)){continue}}}}e=h===1?"next":"prev";if(v!==this.currentItem[0]&&this.placeholder[e]()[0]!==v&&!b.contains(this.placeholder[0],v)&&(this.options.type==="semi-dynamic"?!b.contains(this.element[0],v):true)){if(!this.mouseentered){b(v).mouseenter();this.mouseentered=true}if(m.isTree&&b(v).hasClass(m.collapsedClass)&&m.expandOnHover){if(!this.hovering){b(v).addClass(m.hoveringClass);this.hovering=window.setTimeout(function(){b(v).removeClass(m.collapsedClass).addClass(m.expandedClass);l.refreshPositions();l._trigger("expand",q,l._uiHash())},m.expandOnHover)}}this.direction=h===1?"down":"up";if(this.options.tolerance==="pointer"||this._intersectsWithSides(t)){b(v).mouseleave();this.mouseentered=false;b(v).removeClass(m.hoveringClass);if(this.hovering){window.clearTimeout(this.hovering)}this.hovering=null;if(m.protectRoot&&!(this.currentItem[0].parentNode===this.element[0]&&v.parentNode!==this.element[0])){if(this.currentItem[0].parentNode!==this.element[0]&&v.parentNode===this.element[0]){if(!b(v).children(m.listType).length){v.appendChild(f);if(m.isTree){b(v).removeClass(m.leafClass).addClass(m.branchClass+" "+m.expandedClass)}}if(this.direction==="down"){w=b(v).prev().children(m.listType)}else{w=b(v).children(m.listType)}if(w[0]!==undefined){this._rearrange(q,null,w)}}else{this._rearrange(q,t)}}else{if(!m.protectRoot){this._rearrange(q,t)}}}else{break}this._clearEmpty(v);this._trigger("change",q,this._uiHash());break}}(function(){var i=this.placeholder.prev();if(i.length){s=i}else{s=null}}.call(this));if(s!=null){while(s[0].nodeName.toLowerCase()!=="li"||s[0].className.indexOf(m.disabledClass)!==-1||s[0]===this.currentItem[0]||s[0]===this.helper[0]){if(s[0].previousSibling){s=b(s[0].previousSibling)}else{s=null;break}}}(function(){var i=this.placeholder.next();if(i.length){g=i}else{g=null}}.call(this));if(g!=null){while(g[0].nodeName.toLowerCase()!=="li"||g[0].className.indexOf(m.disabledClass)!==-1||g[0]===this.currentItem[0]||g[0]===this.helper[0]){if(g[0].nextSibling){g=b(g[0].nextSibling)}else{g=null;break}}}this.beyondMaxLevels=0;if(k!=null&&g==null&&!(m.protectRoot&&k[0].parentNode==this.element[0])&&(m.rtl&&(this.positionAbs.left+this.helper.outerWidth()>k.offset().left+k.outerWidth())||!m.rtl&&(this.positionAbs.left<k.offset().left))){k.after(this.placeholder[0]);y=!k.children(m.listItem).children("li:visible:not(.ui-sortable-helper)").length;if(m.isTree&&y){k.removeClass(this.options.branchClass+" "+this.options.expandedClass).addClass(this.options.leafClass)}if(typeof k!=="undefined"){this._clearEmpty(k[0])}this._trigger("change",q,this._uiHash())}else{if(s!=null&&!s.hasClass(m.disableNestingClass)&&(s.children(m.listType).length&&s.children(m.listType).is(":visible")||!s.children(m.listType).length)&&!(m.protectRoot&&this.currentItem[0].parentNode===this.element[0])&&(m.rtl&&(this.positionAbs.left+this.helper.outerWidth()<s.offset().left+s.outerWidth()-m.tabSize)||!m.rtl&&(this.positionAbs.left>s.offset().left+m.tabSize))){this._isAllowed(s,c,c+u+1);if(!s.children(m.listType).length){s[0].appendChild(f);if(m.isTree){s.removeClass(m.leafClass).addClass(m.branchClass+" "+m.expandedClass)}}if(j&&(j<=s.offset().top)){s.children(m.listType).prepend(this.placeholder)}else{s.children(m.listType)[0].appendChild(this.placeholder[0])}if(typeof k!=="undefined"){this._clearEmpty(k[0])}this._trigger("change",q,this._uiHash())}else{this._isAllowed(k,c,c+u)}}this._contactContainers(q);if(b.ui.ddmanager){b.ui.ddmanager.drag(this,q)}this._trigger("sort",q,this._uiHash());this.lastPositionAbs=this.positionAbs;return false},_mouseStop:function(c){if(this.beyondMaxLevels){this.placeholder.removeClass(this.options.errorClass);if(this.domPosition.prev){b(this.domPosition.prev).after(this.placeholder)}else{b(this.domPosition.parent).prepend(this.placeholder)}this._trigger("revert",c,this._uiHash())}b("."+this.options.hoveringClass).mouseleave().removeClass(this.options.hoveringClass);this.mouseentered=false;if(this.hovering){window.clearTimeout(this.hovering)}this.hovering=null;this._relocate_event=c;this._pid_current=b(this.domPosition.parent).parent().attr("id");this._sort_current=this.domPosition.prev?b(this.domPosition.prev).next().index():0;b.ui.sortable.prototype._mouseStop.apply(this,arguments)},_intersectsWithSides:function(f){var g=this.options.isTree?0.8:0.5,d=a(this.positionAbs.top+this.offset.click.top,f.top+(f.height*g),f.height),i=a(this.positionAbs.top+this.offset.click.top,f.top-(f.height*g),f.height),e=a(this.positionAbs.left+this.offset.click.left,f.left+(f.width/2),f.width),c=this._getDragVerticalDirection(),h=this._getDragHorizontalDirection();if(this.floating&&h){return((h==="right"&&e)||(h==="left"&&!e))}else{return c&&((c==="down"&&d)||(c==="up"&&i))}},_contactContainers:function(){if(this.options.protectRoot&&this.currentItem[0].parentNode===this.element[0]){return}b.ui.sortable.prototype._contactContainers.apply(this,arguments)},_clear:function(){var c,d;b.ui.sortable.prototype._clear.apply(this,arguments);if(!(this._pid_current===this._uiHash().item.parent().parent().attr("id")&&this._sort_current===this._uiHash().item.index())){this._trigger("relocate",this._relocate_event,this._uiHash())}for(c=this.items.length-1;c>=0;c--){d=this.items[c].item[0];this._clearEmpty(d)}},serialize:function(d){var f=b.extend({},this.options,d),c=this._getItemsAsjQuery(f&&f.connected),e=[];b(c).each(function(){var h=(b(f.item||this).attr(f.attribute||"id")||"").match(f.expression||(/(.+)[-=_](.+)/)),g=(b(f.item||this).parent(f.listType).parent(f.items).attr(f.attribute||"id")||"").match(f.expression||(/(.+)[-=_](.+)/));if(h){e.push(((f.key||h[1])+"["+(f.key&&f.expression?h[1]:h[2])+"]")+"="+(g?(f.key&&f.expression?g[1]:g[2]):f.rootID))}});if(!e.length&&f.key){e.push(f.key+"=")}return e.join("&")},toHierarchy:function(e){var f=b.extend({},this.options,e),d=[];b(this.element).children(f.items).each(function(){var g=c(this);d.push(g)});return d;function c(h){var i=(b(h).attr(f.attribute||"id")||"").match(f.expression||(/(.+)[-=_](.+)/)),g;if(i){g={id:i[2]};if(b(h).children(f.listType).children(f.items).length>0){g.children=[];b(h).children(f.listType).children(f.items).each(function(){var j=c(this);g.children.push(j)})}return g}}},toArray:function(e){var h=b.extend({},this.options,e),c=h.startDepthCount||0,d=[],f=1;if(!h.excludeRoot){d.push({item_id:h.rootID,parent_id:null,depth:c,left:f,right:(b(h.items,this.element).length+1)*2});f++}b(this.element).children(h.items).each(function(){f=g(this,c+1,f)});d=d.sort(function(j,i){return(j.left-i.left)});return d;function g(m,n,l){var k=l+1,o,j,i;if(b(m).children(h.listType).children(h.items).length>0){n++;b(m).children(h.listType).children(h.items).each(function(){k=g(b(this),n,k)});n--}o=(b(m).attr(h.attribute||"id")).match(h.expression||(/(.+)[-=_](.+)/));if(n===c+1){j=h.rootID}else{i=(b(m).parent(h.listType).parent(h.items).attr(h.attribute||"id")).match(h.expression||(/(.+)[-=_](.+)/));j=i[2]}if(o){d.push({item_id:o[2],parent_id:j,depth:n,left:l,right:k})}l=k+1;return l}},_clearEmpty:function(e){function d(k,j,i,l){if(l){j=[i,i=j][0]}b(k).removeClass(j).addClass(i)}var g=this.options,h=b(e).children(g.listType),c=h.is(":not(:empty)");var f=g.doNotClear||c||g.protectRoot&&b(e)[0]===this.element[0];if(g.isTree){d(e,g.branchClass,g.leafClass,f);if(f&&c){d(e,g.collapsedClass,g.expandedClass)}}if(!f){h.remove()}},_getLevel:function(c){var e=1,d;if(this.options.listType){d=c.closest(this.options.listType);while(d&&d.length>0&&!d.is(".ui-sortable")){e++;d=d.parent().closest(this.options.listType)}}return e},_getChildLevels:function(e,g){var d=this,f=this.options,c=0;g=g||0;b(e).children(f.listType).children(f.items).each(function(h,i){c=Math.max(d._getChildLevels(i,g+1),c)});return g?c+1:c},_isAllowed:function(c,i,f){var h=this.options,d=this.placeholder.closest(".ui-sortable").nestedSortable("option","maxLevels"),e=this.currentItem.parent().parent(),g=h.disableParentChange&&(typeof c!=="undefined"&&!e.is(c)||typeof c==="undefined"&&e.is("li"));if(g||!h.isAllowed(this.placeholder,c,this.currentItem)){this.placeholder.addClass(h.errorClass);if(d<f&&d!==0){this.beyondMaxLevels=f-d}else{this.beyondMaxLevels=1}}else{if(d<f&&d!==0){this.placeholder.addClass(h.errorClass);this.beyondMaxLevels=f-d}else{this.placeholder.removeClass(h.errorClass);this.beyondMaxLevels=0}}}}));b.mjs.nestedSortable.prototype.options=b.extend({},b.ui.sortable.prototype.options,b.mjs.nestedSortable.prototype.options)}));